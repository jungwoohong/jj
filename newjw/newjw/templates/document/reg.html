
{% extends "default.html" %}
{% load static i18n %}
{% block css %}
<link href="{% static 'css/handsonTable.css' %}" rel="stylesheet" class="js-stylesheet">
<link href="{% static 'css/upload.css' %}" rel="stylesheet" > 
<style>
  .handsontable .odd {
 background: #fff 
}
.handsontable .even {
  background: #eee
}

.tab .nav-tabs .nav-link.active {
  border:1px solid !important;
  border-color:#ddd !important;
}

.tab .tab-content {
  border:1px solid !important;
  border-color:#ddd !important;
}
</style>
{% endblock %}

{% block content %}

  <div class="container-fluid p-0">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header" style="padding:20px 0px 0px 22px">
            <h5 class="card-title">
              {% if data.id %}
                문서 수정
              {% else %}
                문서 작성 
              {% endif %}
              </h5>
          </div>
          <div class="card-body" >
            <div class="text-lg-end">
                <button id ="save" class="btn btn-outline-success">저장하기</button>
                <button id ="export-file" class="btn btn-outline-success">엑셀내보내기</button>  
                <button class="btn btn-outline-secondary my-1" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">Excel 업로드</button>            
            </div>               
            <form id="frm">
              <input type="hidden" id="id" name="id" value="" />
              <input type="hidden" id="start_date" name="start_date" value="" />
              <input type="hidden" id="end_date" name="end_date" value="" />
              <input type="hidden" id="json_data" name="json_data" value="" />
              <div class="mb-3 row">
                <label class="col-form-label col-sm-2 text-sm-right">제목</label>
                <div class="col-sm-10">
                  <input type="text" class="form-control" id="title" name ="title" placeholder="" value="{{ data.title }}">
                  <label id="title-error" class="error jquery-validation-error small form-text invalid-feedback" for="validation-required" ></label>
                </div>
              </div>
              <div class="mb-3 row">
                <label class="col-form-label col-sm-2 text-sm-right">기간 설정</label>
                <div id="reportrange" class="overflow-hidden col-sm-10 form-control" style="width:210px;margin-left:12px;">
                  <i class="far fa-calendar"></i>&nbsp;
                  <span></span> <i class="fas fa-caret-down"></i>
                </div>
              </div>                                        
            </form>
            <div class="col-12">
							<div class="tab">
								<ul class="nav nav-tabs" role="tablist">
									<li class="nav-item"><a class="nav-link active" href="#tab-1" data-bs-toggle="tab" role="tab">Sheet1</a></li>
								</ul>
								<div class="tab-content">
									<div class="tab-pane active" id="tab-1" role="tabpanel">
                    <div id="excelGrid"> </div>
									</div>                
								</div>
							</div>
						</div>            
          </div>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

{% block layerHtml %}
    
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
  <div class="offcanvas-header">
    <h5 id="offcanvasRightLabel">Excel Upload</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <div>
      {% include "document/uploadIn.html" %}
    </div>
  </div>
</div> 
{% endblock layerHtml %}

{% block inline_javascript %}

<script src="{% static 'js/handsonTable.min.js' %}"></script>
<script src="{% static 'js/handsonLangKo.js' %}"></script>
<script>
    
  const container = document.querySelector('#excelGrid');
  const save = document.querySelector('#save');

  function loadExcelData(id){
    $.ajax({        
      type : 'POST',
      url : "{% url 'frameJsonData' %}",        
      dataType : 'json',        
      data : {id:id},
      success : function(data) {
        hot.loadData(data.data);
      }
    }); 
  }

const hot = new Handsontable(container, {
  startRows: 20,
  startCols: 20,  
  width: 'auto',
  height: 'auto',
  rowHeaders: true,
  colHeaders: true,
  contextMenu: true,
  dropdownMenu: true,
  multiColumnSorting: true,
  filters: true,
  manualRowMove: true,  
  comments: true,
  language: 'ko-KR',
  mergeCells:[],
  fillHandle: true,
  cells(row) {
    return {
    	className: row % 2 === 0 ? 'even' : 'odd',
    };
  },
  afterChange: (changes) => {
    changes?.forEach(([row, prop, oldValue, newValue]) => {
    });
  }, 
  // columns: [
  //   {
  //     type: 'autocomplete',
  //     source(query, process) {
  //       $.ajax({        
  //         type : 'POST',
  //         url : "",        
  //         dataType : 'json',        
  //         data : {query:query},
  //         success : function(data) {
  //           process(data.data) 
  //         }
  //       });         
  //     },
  //     strict: false
  //   },
  //   {
  //     type: 'autocomplete',
  //     source(query, process) {
  //       fetch('https://handsontable.com/docs/scripts/json/autocomplete.json')
  //         .then(response => response.json())
  //         .then(response => process(response.data));
  //     },
  //     strict: false
  //   },    
  // ],
  licenseKey: 'non-commercial-and-evaluation'
});


const exportPlugin = hot.getPlugin('exportFile');
const button = document.querySelector('#export-file');

button.addEventListener('click', () => {
  exportPlugin.downloadFile('csv', {
    bom: false,
    columnDelimiter: ',',
    columnHeaders: false,
    exportHiddenColumns: true,
    exportHiddenRows: true,
    fileExtension: 'csv',
    filename: 'Handsontable-CSV-file_[YYYY]-[MM]-[DD]',
    mimeType: 'text/csv',
    rowDelimiter: '\r\n',
    rowHeaders: true
  });
});

save.addEventListener('click', () => {

  let from = $('#frm');
  $('#json_data').val(JSON.stringify(hot.getData()));

    $.ajax({        
      type : 'POST',
      url : "{% url 'docSave' %}",        
      dataType : 'json',        
      data : from.serialize(),
      success : function(data) {

        if(data.form.length == 0){
          alert(data.msg)
        } else {
          formError(data.form);
        } 
      }
    });          
  });

  navFun('documentManage',1,0);

  const dropFile = new DropFile("drop-file", "files");

  
$('#uploadBtn').click(function(){

    var form = new FormData();    
    form.append( "file1", filesVal[0],filesVal[0].name );
  
     jQuery.ajax({
         url : "{% url 'docUpload' %}"
       , type : "POST"
       , processData : false
       , contentType : false
       , data : form
       , success:function(data) {
          hot.loadData(data.data);
          uploadFiles = [];
          $('#files > .fileDiv').remove();
          $('#offcanvasRight').offcanvas('hide');
           
       }
       ,error: function (jqXHR) 
       { 
           alert(jqXHR.responseText); 
       }
   });
});

  var start = moment();
  var end = moment().subtract(-6, "days");
  $('#start_date').val(start.format("YYYY.MM.DD"));
  $('#end_date').val(end.format("YYYY.MM.DD"));

  function cb(start, end) {
    let dtStart = start.format("YYYY.MM.DD");
    let dtEnd   = end.format("YYYY.MM.DD");

    $("#reportrange span").html(dtStart + " - " + dtEnd);
    $('#start_date').val(dtStart);
    $('#end_date').val(dtEnd);
  }

  $("#reportrange").daterangepicker({
    startDate: start,
    endDate: end,
    "locale": daterangepickerLocalKr,
    ranges: {
      "14일간": [moment(),moment().subtract(-14, "days")],
      "30일간": [moment(),moment().subtract(-29, "days")],
      "60일간": [moment(),moment().subtract(-59, "days")],
    }
  }, cb);
  cb(start, end);
</script>
{% endblock inline_javascript %}